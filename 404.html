<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/style.css">
    <script src="/index.js"></script>

</head>

<body>
    <script>

        const apilink = "https://purple-cherry-974e.princeojeda52.workers.dev/";
        // const apilink = "https://wild-mouse-612a.princeojeda52.workers.dev/";
        // const apilink = "http://127.0.0.1:8787/";


        const getCountry = async (country) => {
            await fetch(apilink + 'api/country/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: country
                })
            })
                .then(response => response.json())
                .then(async (data) => {
                    await fetch("/tours/tours2content.html")
                        .then(response => response.text())
                        .then(html => {

                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');

                            let body = doc.querySelector('body');

                            body.querySelector('img').src = data.image;

                            //pins
                            let pins = body.querySelector('div.country-map');
                            data.tours.forEach(tour => {
                                let a = document.createElement('a');
                                a.href = `/tours/${country}/${tour["name"]}`;
                                let svg = '<svg height="512" viewBox="0 0 64 64" width="512" xmlns="http://www.w3.org/2000/svg"><g id="Pin"><path d="m32 0a24.0319 24.0319 0 0 0 -24 24c0 17.23 22.36 38.81 23.31 39.72a.99.99 0 0 0 1.38 0c.95-.91 23.31-22.49 23.31-39.72a24.0319 24.0319 0 0 0 -24-24zm0 35a11 11 0 1 1 11-11 11.0066 11.0066 0 0 1 -11 11z"/></g></svg>';
                                a.innerHTML = svg;
                                a.innerHTML += tour["name"];
                                a.classList.add('pin');
                                a.style.top = `${tour["xy"].split(",")[0]}%`;
                                a.style.left = `${tour["xy"].split(",")[1]}%`;
                                pins.appendChild(a);

                            });

                            body.querySelector('h1.title').innerText = data.name;
                            body.querySelector('p.description').innerText = data.description;

                            document.body.innerHTML = body.innerHTML;

                        });

                });
        };

        const getTour = async (country, tour) => {
            await fetch(apilink + 'api/tours/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    country: country,
                    tour: tour
                })
            }).then(response => response.json())
                .then(async (data) => {

                    await fetch("/tours/tours3content.html")
                        .then(response => response.text())
                        .then(html => {

                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');

                            let body = doc.querySelector('body');

                            body.querySelector('h1.title').innerText = data.name;
                            body.querySelector('p.description').innerText = data.description;
                            body.querySelector('p.price').innerText = data.price;

                            body.querySelector('.add-to-travel-list').disabled = true;

                            document.body.innerHTML = body.innerHTML;

                        });

                }).catch(error => {
                    document.body.innerHTML = '<h1>Page Not Found</h1><p>The page you are looking for does not exist.</p>';
                });
        };


        document.addEventListener('DOMContentLoaded', async () => {
            const path = window.location.pathname;
            if (path.startsWith('/tours/')) {

                let paths = path.split('/');

                paths.shift();

                paths = paths.filter(path => path !== '');

                const count = paths.length;

                if (count === 2) {

                    const country = decodeURIComponent(paths[1]);

                    await getCountry(country);

                } else if (count === 3) {

                    const country = decodeURIComponent(paths[1]);
                    const tour = decodeURIComponent(paths[2]);

                    await getTour(country, tour);

                } else {
                    document.body.innerHTML = '<h1>Page Not Found</h1><p>The page you are looking for does not exist.</p>';
                }

            } else {
                document.body.innerHTML = '<h1>Page Not Found</h1><p>The page you are looking for does not exist.</p>';
            }
        });

    </script>
</body>

</html>